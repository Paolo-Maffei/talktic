<html>
<head>
<script type="text/javascript">
//<![CDATA[
Number.prototype.zsHex = function(len) {
	if(len == undefined) {
		len = 0;
	}
	var h = this.toString(16).toUpperCase();
	var zs = '';
	for(var i=0; i<len - h.length; i++) {
		zs += '0'
	}
	return zs + h;
}
String.prototype.intelHex = function() {
	var h = "";
	for(var i=0; i<this.length && i < 0xFFFF; i+= 16) {
		var s = 0;
		var l = Math.min(this.length - i, 16);
		h += ':' + l.zsHex(2) + i.zsHex(4) + '00';
		s += l;
		s += ((i >> 8) & 0xFF);
		s += i & 0xFF;
		for(var j=0; j<l; j++) {
			var code = this.charCodeAt(i+j);
			h += code.zsHex(2);
			s += code;
		}
		var cs = (0x100 - (s & 0xFF)) & 0xFF;
//		h += (cs+s).zsHex(2);
		h += cs.zsHex(2) + "\n";
	}
	h += ':00000001FF';
	return h;
}
function File(name) {
	this.name = name;
	this.opentype = 'rw';
	this.position = 0;
	this.binary = "";
	this.text = "";
}
File.prototype.open = function(a) {
	if(a) {
		this.opentype = a;
	}
	if($(this.name).tagName == 'TEXTAREA') {
		this.text = $(this.name).value;
	} else {
		this.text = $(this.name).innerHTML;
	}
	this.position = 0;
	this.binary = "";
	return true;
}
File.prototype.close = function() {
	if(this.opentype.indexOf('w') != -1) {
		var e;
		if(e = $(this.name + "_bin")) {
			var bin = "data:application/octet-stream;base64," + base64encode(this.binary);
			e.innerHTML = "<a href='"+bin+"'>"+this.name+".bin</a>";
		}
		if(e = $(this.name + "_hex")) {
			var hex = this.binary.intelHex();
			//e.innerHTML = hex;
			var bin = "data:application/octet-stream;base64," + base64encode(hex);
			e.innerHTML = "<a href='"+bin+"'>"+this.name+".hex</a>";
		}
	}
	return true;
}
File.prototype.readByte = function() {
	if(this.position >= this.text.length) {
		return -1;
	}
	return this.text.charCodeAt(this.position++);
}
File.prototype.readln = function() {
	var ret = "";
	for(;this.position<this.text.length;this.position++) {
		var ch = this.text.charAt(this.position);
		ret += ch;
		if(ch == '\r' || ch == '\n') {
			if(ch == '\r' && this.text.charAt(this.position+1) == '\n') {
				this.position++;
			}
			break;
		}
	}
	return ret;
}
File.prototype.setPosition = function(p) {
	this.position = p;
}
File.prototype.ungetByte = function(b) {
	this.position --;
}
File.prototype.write = function(a) {
	if(this.opentype.indexOf('w') != -1) {
		this.binary += a;
		$(this.name).innerHTML += a;
		var r = "";
		for(var i=0; i<a.length; i++) {
			r += (a.charCodeAt(i).toString(16)) + " ";
			if(i % 16 == 15) {
				r += "<br />";
			}
		}
		$(this.name).innerHTML += "<small>" + r + "</small>\n";
	}
}
File.prototype.writeln = function(a) {
	this.write(a + "\n");
}
File.byteToString = function(b) {
	return String.fromCharCode(b);
}
String.prototype.append = function(a) {
	if(typeof a == 'string') {
		return this + a;
	} else if(typeof a == 'number') {
		return this + String.fromCharCode(a);
	}
}
String.pack = function(s) {
	var r = "";
	var j = 1;
	for(var i=0; i<s.length; i++) {
		switch(s.charAt(i)) {
		case 'C':
			r += String.fromCharCode(arguments[j++] & 0xff);
			break;
		case 'N':
			var v = arguments[j++];
			r += String.fromCharCode(v >> 24 & 0xff);
			r += String.fromCharCode(v >> 16 & 0xff);
			r += String.fromCharCode(v >> 8 & 0xff);
			r += String.fromCharCode(v & 0xff);
			break;
		case 'n':
			var v = arguments[j++];
			r += String.fromCharCode(v >> 8 & 0xff);
			r += String.fromCharCode(v & 0xff);
			break;
		case 'd':
			var bp = new BinaryParser(false, false);
			r += bp.fromDouble(arguments[j++]);
			break;
/* // something wrong for 64bit...
			var v = arguments[j++];
			var ieee754 = 0;
			var f = Math.abs(v);
			var e = 0;
			var d = true;
			while (f >= 2.0) {
				e += 1;
				f /= 2.0;
			}
			while (f < 1.0) {
				e -= 1;
				f *= 2.0;
			}
			f -= 1.0;
			f *= 2.0;
			for(var k=0; k<(d ? 52 : 23); k++) {
				if(f >= 1.0) {
					ieee754 = (ieee754 << 1) + 1;
					f -= 1.0;
				} else {
					ieee754 = ieee754 << 1;
				}
				f *= 2.0;
			}
			if(d) {
				e = (e + 1023) & 0x7ff;
				ieee754 = (e << 52) + ieee754;
				r += String.fromCharCode(ieee754 >> 56 & 0xff + (v < 0.0 ? 0x80 : 0));
				r += String.fromCharCode(ieee754 >> 48 & 0xff);
				r += String.fromCharCode(ieee754 >> 40 & 0xff);
				r += String.fromCharCode(ieee754 >> 32 & 0xff);
				r += String.fromCharCode(ieee754 >> 24 & 0xff);
				r += String.fromCharCode(ieee754 >> 16 & 0xff);
				r += String.fromCharCode(ieee754 >>  8 & 0xff);
				r += String.fromCharCode(ieee754 >>  0 & 0xff);
			} else {
				e = (e + 127) & 0xff;
				ieee754 = (e << 23) + ieee754;
				r += String.fromCharCode(ieee754 >> 24 & 0xff + (v < 0.0 ? 0x80 : 0));
				r += String.fromCharCode(ieee754 >> 16 & 0xff);
				r += String.fromCharCode(ieee754 >>  8 & 0xff);
				r += String.fromCharCode(ieee754 >>  0 & 0xff);
			}
			System.stdout.write(r);
*/
}
	}
	return r;
}
function isInt(a) {
	return a == Math.floor(a);
}
function isFloat(a) {
	return a != Math.floor(a);
}
var error = function(a) {
	System.stderr.write(a);
	exit();
}
var System = {stderr: new File('stderr'), stdout: new File('stdout')};
function make() {
	$('asm').innerHTML = "";
	$('bc').innerHTML = "";
	$('stdout').innerHTML = "";
	$('stderr').innerHTML = "";
	var flag = JSC$FLAG_VERBOSE;// | JSC$FLAG_GENERATE_DEBUG_INFO;
	$('bc_hex').innerHTML = "<img src='spinner.gif' />";
	setTimeout(function() {
		JSC$compile_file('source', flag, 'asm', 'bc');
	}, 2);
}
//]]>
</script>
<script type="text/javascript">
function setSelectionRange(input, selectionStart, selectionEnd) {
  if (input.setSelectionRange) {
    input.focus();
    input.setSelectionRange(selectionStart, selectionEnd);
  }
  else if (input.createTextRange) {
    var range = input.createTextRange();
    range.collapse(true);
    range.moveEnd('character', selectionEnd);
    range.moveStart('character', selectionStart);
    range.select();
  }
}
function replaceSelection (input, replaceString) {
	if (input.setSelectionRange) {
		var selectionStart = input.selectionStart;
		var selectionEnd = input.selectionEnd;
		input.value = input.value.substring(0, selectionStart)+ replaceString + input.value.substring(selectionEnd);
		if (selectionStart != selectionEnd){ 
			setSelectionRange(input, selectionStart, selectionStart + 	replaceString.length);
		} else {
			setSelectionRange(input, selectionStart + replaceString.length, selectionStart + replaceString.length);
		}
	} else if (document.selection) {
		var range = document.selection.createRange();
		if (range.parentElement() == input) {
			var isCollapsed = range.text == '';
			range.text = replaceString;
			if (!isCollapsed)  {
				range.moveStart('character', -replaceString.length);
				range.select();
			}
		}
	}
}
function catchTab(item,e) {
	if(navigator.userAgent.match("Gecko")){
		c = e.which;
	} else {
		c = e.keyCode;
	}
	if(c == 9) {
		replaceSelection(item,String.fromCharCode(9));
		setTimeout("document.getElementById('"+item.id+"').focus();",0);	
		return false;
	}
}
</script>

<script type="text/javascript" src="asm.js"></script>
<script type="text/javascript" src="compiler.js"></script>
<script type="text/javascript" src="defs.js"></script>
<script type="text/javascript" src="entry.js"></script>
<script type="text/javascript" src="gram.js"></script>
<script type="text/javascript" src="lexer.js"></script>
<script type="text/javascript" src="namespace.js"></script>
<script type="text/javascript" src="parser.js"></script>
<script type="text/javascript" src="streams.js"></script>
<script type="text/javascript" src="prototype.js"></script>
<script type="text/javascript" src="base64.js"></script>
<script type="text/javascript" src="binary-parser.js"></script>
<!--
<script type="text/javascript" src="ieerbug/ieerbug.js"></script>
-->
<style>
body {
	font-size: 12px;
	font-family: "Courier New";
}
textarea {
	width: 100%;
	height: 300px;
	border: 1px solid #ddd;
	font-family: "Courier New";
}
pre {
	background: #eee;
	width: 100%;
	border: 1px solid #ddd;
	font-family: "Courier New";
}
small {
	color: #999;
}
</style>
</head>
<body>
<h1>Talktic Scripting</h1>
<div>
<input type="button" onclick="make();" value="make" />
<input type="button" onclick="Element.toggle($('out'))" value="Toggle Output" />
</div>
<div>
script:<textarea id="source" onkeydown="return catchTab(this,event)">
while(true) {
}

function blink() {
	led(true);
	for(var i=0; i<200; i++) {
	}
	led(false);
}

function onDigitalIo() {
	blink();
}
</textarea>
</div>
<div id="bc_hex"></div>
<div id="out" style="display: none;">
asm:<span id="asm_bin"></span><pre id="asm"></pre>
bc:<span id="bc_bin"></span><pre id="bc"></pre>
stdout:<pre id="stdout"></pre>
stderr:<pre id="stderr"></pre>
</div>
</body>
</html>
